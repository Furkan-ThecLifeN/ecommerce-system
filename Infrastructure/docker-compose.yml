version: '3.8'

services:
  # --- DATABASE: MSSQL SERVER ---
  mssql:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: mssql-db
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=YourStrongPassword123!
      - MSSQL_PID=Developer
    ports:
      - "1433:1433"
    volumes:
      - ./mssql/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    networks:
      - ecommerce-net

  # --- CACHING: REDIS ---
  redis:
    image: redis:7-alpine
    container_name: redis-cache
    ports:
      - "6379:6379"
    networks:
      - ecommerce-net

  # --- MESSAGING: KAFKA ---
  zookeeper:
    image: bitnami/zookeeper:latest
    environment:
      - ALLOW_ANONYMOUS_LOGIN=yes
    networks:
      - ecommerce-net

  kafka:
    image: bitnami/kafka:latest
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      - KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper:2181
      - ALLOW_PLAINTEXT_LISTENER=yes
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
    networks:
      - ecommerce-net

  # --- CENTRALIZED LOGGING: ELK ---
  elasticsearch:
    image: elasticsearch:8.10.2
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
    networks:
      - ecommerce-net

  logstash:
    image: logstash:8.10.2
    volumes:
      - ./elk/logstash.conf:/usr/share/logstash/pipeline/logstash.conf
    depends_on:
      - elasticsearch
    networks:
      - ecommerce-net

  # --- INFRASTRUCTURE SERVICES ---
  discovery-server:
    build: ../discovery-server
    ports:
      - "8761:8761"
    networks:
      - ecommerce-net

  api-gateway:
    build: ../api-gateway
    depends_on:
      - discovery-server
    ports:
      - "8080:8080"
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka/
    networks:
      - ecommerce-net

  # --- BUSINESS SERVICES (Ã–rnek: Auth Service) ---
  auth-service:
    build: ../auth-service
    depends_on:
      - mssql
      - discovery-server
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_DATASOURCE_URL=jdbc:sqlserver://mssql:1433;databaseName=auth_db;encrypt=true;trustServerCertificate=true
      - SPRING_DATASOURCE_USERNAME=sa
      - SPRING_DATASOURCE_PASSWORD=YourStrongPassword123!
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    networks:
      - ecommerce-net

networks:
  ecommerce-net:
    driver: bridge